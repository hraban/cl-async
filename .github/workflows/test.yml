name: "Test"

on:
  push:
    branches:
      - '**'

jobs:
  examples:
    timeout-minutes: 10
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Install Lisp etc
        run: |
          sudo apt-get install -y --no-install-recommends sbcl libuv1{,-dev} wget
      - name: Install QuickLisp
        run: |
          wget https://beta.quicklisp.org/quicklisp.lisp
          sbcl --noinform --disable-ldb --lose-on-corruption --end-runtime-options \
               --disable-debugger --no-userinit --no-sysinit --noprint \
               --load quicklisp.lisp \
               --eval '(quicklisp-quickstart:install)' \
               --quit
          mkdir -p ~/quicklisp/local-projects/
          ln -s "$PWD" ~/quicklisp/local-projects/cl-async
      - name: Run echo-server.lisp
        run: |
          set -xeuo pipefail
          # For some insane reason you need to touch the SBCL binary somehow
          # before you background it, or it won’t be killable with SIGINT.
          # Don’t ask me how I figured this out. Where would one even report
          # this bug?
          cat $(which sbcl) > /dev/null
          sbcl --noinform --disable-ldb --lose-on-corruption --end-runtime-options \
               --load ~/quicklisp/setup.lisp \
               --script examples/echo-server.lisp &
          pid="$!"
          while ! nc -z localhost 5000 ; do sleep 0.1 ; done
          [[ "Hello brother" == "$(echo Hello brother | nc localhost 5000)" ]]
          kill -INT "$pid"
          wait "$pid"
          rm examples/echo-server.lisp
      - name: Run other examples
        run: |
          set -xeuo pipefail
          for f in examples/*.lisp; do
            sbcl --noinform --disable-ldb --lose-on-corruption --end-runtime-options \
                 --load ~/quicklisp/setup.lisp \
                 --script "$f"
          done
